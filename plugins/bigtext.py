import re
import json

from bot.events import command, Callback
from util.irc import Message
from util.text import ircstrip, minify, generate_vulgarity

def parse(btf):
    data = open(btf).read().split("\n")
    num = None
    ds = {}
    for i in data:
        if i.startswith("#"):
            num = chr(int(i[1:]))
        else:
            ds.setdefault(num, []).append(i)
    return ds

def big(f, ds):
    if "\n" in f:
        return "\n".join(big(i, ds) for i in f.split("\n"))
    return "\n".join("".join(p) for p in zip(*[expand(i, ds) for i in re.split(r"(\x03(?:\d{0,2}(?:,\d{1,2})?)?|\x1f|\x0f|\x16|\x02|.)", f) if i]))

def expand(char, ds):
    backup = ds[None]
    if re.match(r"(\x03(\d{0,2}(,\d{1,2})?)?|\x0f|\x16|\x02)", char):
        return [char] * len(backup)
    elif char == "\x1f":
        return [""] * (len(backup) - 1) + [char]
    else:
        return ds.get(char, backup)

colors = [13, 4, 8, 12, 13, 9, 11, 12]
k = len(colors)

mapping = {"dong":"â‚«",
           "snowman": "â˜ƒ",
           "lovehotel": "ðŸ©",
           "bear": "à¼¼ ã¤ â—•_â—• à¼½ã¤",
           "bface": "(ï½¡â—•â€¿â€¿â—•ï½¡)",
           "gface":"( â‰–â€¿â‰–)",
           "dface":"à² _à² ",
           "gay": "ðŸ‘¬",
           "flower": "âœ¿",
           "poo": "ðŸ’©",
           "man": "ðŸ‘¨",
           "lion": "ðŸ±",
           "kface":"(â—•â€¿â—•âœ¿)",
           "finn":"| (â€¢ â—¡â€¢)|",
           "jake": "(âá´¥âÊ‹)",
           "wface":"(âŠ™â–‚âŠ™)",
           "cface":"(â•¥ï¹â•¥)",
           "goface":"Ê• â—”Ï–â—”Ê”",
           "eface":"(ã‚±â‰–â€¿â‰–)ã‚±",
           "hface": "â”('~` ;)â”Œ",
           "lhoof": "/)",
           "rhoof": "(\\",
           "brohoof": "/) (\\",
           "omega": "Ï‰",
           "doge": "ðŸ¶",
           "denko": "(Â´ãƒ»Ï‰ãƒ»`)",
           "chownface": "( Â´Â· â€¿ Â·`)",
           "shrug": "Â¯\_(ãƒ„)_/Â¯",
           "dongers": "ãƒ½à¼¼àºˆÙ„Íœàºˆà¼½ï¾‰",
           "lenny": "( Í¡Â° ÍœÊ– Í¡Â°)",
           "sface": "ëˆˆ_ëˆˆ",
           "fface": "(à¸‡ Â° Ù„ Â°)à¸‡",
           "hug": "c(Ë˜âŒ£Ë˜)â†„", 
           "yayy": r"Âºâ•²Ëš\â•­á´–_á´–â•®/Ëšâ•±Âº", 
           "palette": ' '.join(['\x03,{0:02}  \x0f\x03{0:02} {0:02}\x0f'.format(i) for i in range(16)])}

mapping.update(json.load(open("data/Unicode/unimath.js")))

thicker = {"â•®": "â”“", "â•­":"â”", "â•°": "â”—", "â•¯":"â”›", 'â•¿': 'â”ƒ', 'â•¾': 'â”', 'â•½': 'â”ƒ', 'â•¼': 'â”', 'â•·': 'â•»', 'â•¶': 'â•º', 'â•µ': 'â•¹', 'â•´': 'â•¸', 'â•Š': 'â•‹', 'â•‰': 'â•‹', 'â•ˆ': 'â•‹', 'â•Ž': 'â•', 'â•Œ': 'â•', 'â•ƒ': 'â•‹', 'â•‚': 'â•‹', 'â•': 'â•‹', 'â•€': 'â•‹', 'â•‡': 'â•‹', 'â•†': 'â•‹', 'â•…': 'â•‹', 'â•„': 'â•‹', 'â”º': 'â”»', 'â”¹': 'â”»', 'â”¸': 'â”»', 'â”¿': 'â•‹', 'â”¾': 'â•‹', 'â”½': 'â•‹', 'â”¼': 'â•‹', 'â”²': 'â”³', 'â”±': 'â”³', 'â”°': 'â”³', 'â”·': 'â”»', 'â”¶': 'â”»', 'â”µ': 'â”»', 'â”´': 'â”»', 'â”ª': 'â”«', 'â”©': 'â”«', 'â”¨': 'â”«', 'â”¯': 'â”³', 'â”®': 'â”³', 'â”­': 'â”³', 'â”¬': 'â”³', 'â”¢': 'â”£', 'â”¡': 'â”£', 'â” ': 'â”£', 'â”§': 'â”«', 'â”¦': 'â”«', 'â”¥': 'â”«', 'â”¤': 'â”«', 'â”š': 'â”›', 'â”™': 'â”›', 'â”˜': 'â”›', 'â”Ÿ': 'â”£', 'â”ž': 'â”£', 'â”': 'â”£', 'â”œ': 'â”£', 'â”’': 'â”“', 'â”‘': 'â”“', 'â”': 'â”“', 'â”–': 'â”—', 'â”•': 'â”—', 'â””': 'â”—', 'â”Š': 'â”‹', 'â”ˆ': 'â”‰', 'â”Ž': 'â”', 'â”': 'â”', 'â”Œ': 'â”', 'â”‚': 'â”ƒ', 'â”€': 'â”', 'â”†': 'â”‡', 'â”„': 'â”…'}
reverse = {'âŽ›':'âŽž','âŽž':'âŽ›','âŽ ':'âŽ','âŽ':'âŽ ','âšž':'âšŸ','âšŸ':'âšž','3':'Æ','Æ':'3','â†ƒ':'C','C':'â†ƒ','ÆŽ':'E','E':'ÆŽ','N':'á´Ž','á´Ž':'N','q':'p','p':'q','â…':'â†','â†':'â…','c':'É”','É”':'c','ØŸ':'?','?':'ØŸ','>':'<','<':'>','[':']',']':'[','{':'}','}':'{','(':')',')':'(','/':'\\','\\':'/','d':'b','b':'d','â•‰': 'â•Š', 'â•Š': 'â•‰', 'â•ƒ': 'â•„', 'â•„': 'â•ƒ', 'â•…': 'â•†', 'â•†': 'â•…', 'â•˜': 'â•›', 'â•™': 'â•œ', 'â•š': 'â•', 'â•›': 'â•˜', 'â•œ': 'â•™', 'â•': 'â•š', 'â•ž': 'â•¡', 'â•Ÿ': 'â•¢', 'â•’': 'â••', 'â•“': 'â•–', 'â•”': 'â•—', 'â••': 'â•’', 'â•–': 'â•“', 'â•—': 'â•”', 'â•­': 'â•®', 'â•®': 'â•­', 'â•¯': 'â•°', 'â• ': 'â•£', 'â•¡': 'â•ž', 'â•¢': 'â•Ÿ', 'â•£': 'â• ', 'â•¸': 'â•º', 'â•º': 'â•¸', 'â•¼': 'â•¾', 'â•¾': 'â•¼', 'â•°': 'â•¯', 'â•±': 'â•²', 'â•²': 'â•±', 'â•´': 'â•¶', 'â•¶': 'â•´', 'â”Œ': 'â”', 'â”': 'â”‘', 'â”Ž': 'â”’', 'â”': 'â”“', 'â”˜': 'â””', 'â”™': 'â”•', 'â”š': 'â”–', 'â”›': 'â”—', 'â”œ': 'â”¤', 'â”': 'â”¥', 'â”ž': 'â”¦', 'â”Ÿ': 'â”§', 'â”': 'â”Œ', 'â”‘': 'â”', 'â”’': 'â”Ž', 'â”“': 'â”', 'â””': 'â”˜', 'â”•': 'â”™', 'â”–': 'â”š', 'â”—': 'â”›', 'â”¨': 'â” ', 'â”©': 'â”¡', 'â”ª': 'â”¢', 'â”«': 'â”£', 'â”­': 'â”®', 'â”®': 'â”­', 'â” ': 'â”¨', 'â”¡': 'â”©', 'â”¢': 'â”ª', 'â”£': 'â”«', 'â”¤': 'â”œ', 'â”¥': 'â”', 'â”¦': 'â”ž', 'â”§': 'â”Ÿ', 'â”¹': 'â”º', 'â”º': 'â”¹', 'â”½': 'â”¾', 'â”¾': 'â”½', 'â”±': 'â”²', 'â”²': 'â”±', 'â”µ': 'â”¶', 'â”¶': 'â”µ'}
upturned = {'âŽž':'âŽ ','âŽ ':'âŽž','âŽ':'âŽ›','âŽ›':'âŽ','/':'\\','\\':'/','9':'6','6':'9','!':'Â¡','Â¡':'!','Â¿':'ØŸ','ØŸ':'Â¿','`':',',',':'`','â€¾':'_','_':'â€¾','^':'v','v':'^','"':'â€ž','â€ž':'"','â…‹':'&','&':'â…‹',';':'Ø›','Ø›':';','âˆ€':'A','A':'âˆ€','â„²':'F','F':'â„²','L':'â…‚','â…‚':'L','M':'W','W':'M','G':'â…','â…':'G','Y':'â…„','â…„':'Y','P':'b','b':'P','p':'b','b':'p','Q':'ÎŒ','ÎŒ':'Q','R':'á´š','á´š':'R','T':'âŠ¥','âŠ¥':'T','U':'âˆ©','âˆ©':'U','V':'á´§','á´§':'V','h':'É¥','É¥':'h','j':'É¾','É¾':'j','k':'Êž','Êž':'k','l':'Êƒ','Êƒ':'l','m':'É¯','É¯':'m','n':'u','u':'n','a':'É','É':'a','d':'q','q':'d','e':'Ç','Ç':'e','f':'ÉŸ','ÉŸ':'f','g':'Æƒ','Æƒ':'g','y':'ÊŽ','ÊŽ':'y','t':'Ê‡','Ê‡':'t','âˆ´':'âˆµ','âˆµ':'âˆ´','v':'ÊŒ','ÊŒ':'v','w':'Ê','Ê':'w','â€¿':'â€','â€':'â€¿','.':'Ë™','Ë™':'.','â•ˆ': 'â•‡', 'â•€': 'â•', 'â•': 'â•€', 'â•ƒ': 'â•…', 'â•„': 'â•†', 'â•…': 'â•ƒ', 'â•†': 'â•„', 'â•‡': 'â•ˆ', 'â•˜': 'â•’', 'â•™': 'â•“', 'â•š': 'â•”', 'â•›': 'â••', 'â•œ': 'â•–', 'â•': 'â•—', 'â•’': 'â•˜', 'â•“': 'â•™', 'â•”': 'â•š', 'â••': 'â•›', 'â•–': 'â•œ', 'â•—': 'â•', 'â•¨': 'â•¥', 'â•©': 'â•¦', 'â•­': 'â•°', 'â•®': 'â•¯', 'â•¯': 'â•®', 'â•¤': 'â•§', 'â•¥': 'â•¨', 'â•¦': 'â•©', 'â•§': 'â•¤', 'â•¹': 'â•»', 'â•»': 'â•¹', 'â•½': 'â•¿', 'â•¿': 'â•½', 'â•°': 'â•­', 'â•±': 'â•²', 'â•²': 'â•±', 'â•µ': 'â•·', 'â•·': 'â•µ', 'â”Œ': 'â””', 'â”': 'â”•', 'â”Ž': 'â”–', 'â”': 'â”—', 'â”˜': 'â”', 'â”™': 'â”‘', 'â”š': 'â”’', 'â”›': 'â”“', 'â”ž': 'â”Ÿ', 'â”Ÿ': 'â”ž', 'â”': 'â”˜', 'â”‘': 'â”™', 'â”’': 'â”š', 'â”“': 'â”›', 'â””': 'â”Œ', 'â”•': 'â”', 'â”–': 'â”Ž', 'â”—': 'â”', 'â”©': 'â”ª', 'â”ª': 'â”©', 'â”¬': 'â”´', 'â”­': 'â”µ', 'â”®': 'â”¶', 'â”¯': 'â”·', 'â”¡': 'â”¢', 'â”¢': 'â”¡', 'â”¦': 'â”§', 'â”§': 'â”¦', 'â”¸': 'â”°', 'â”¹': 'â”±', 'â”º': 'â”²', 'â”»': 'â”³', 'â”°': 'â”¸', 'â”±': 'â”¹', 'â”²': 'â”º', 'â”³': 'â”»', 'â”´': 'â”¬', 'â”µ': 'â”­', 'â”¶': 'â”®', 'â”·': 'â”¯'}


def subs(g):
    key = g.group(0)[1:]
    if key in mapping:
        return mapping[key]
    elif key == "insult":
        return generate_vulgarity().lower()
    elif key == "INSULT":
        return generate_vulgarity().upper()
    else:
        return "$" + key

def thicken(text):
    return "".join(thicker.get(i, i) for i in text)

def flip(text):
    return "\n".join("".join(reverse.get(i, i) for i in line[::-1]) for line in text.split("\n"))

def upside_down(text):
    return "\n".join("".join(upturned.get(i, i) for i in line) for line in text.split("\n")[::-1])


@Callback.threadsafe
@command("big bigger", "(?:-([rbclt!fu]*)([1-5])?\s+)?(.+)?")
def bigtext(server, message, flags, lines, text):
    if lines:
        lines = int(lines)
    elif message.command == "bigger":
        lines = 5
    else:
        lines = 3
    if not flags: flags = ""
    if "!" not in flags:
        text = re.sub(r"\$[a-z]+", subs, text, flags=re.IGNORECASE)
    if len(text * lines) > 90:
        text = text[:int(90/lines)] + "..."
    if "c" in flags:
        text = text.upper()
    if "l" in flags:
        text = text.lower()
    if lines > 1:
        ds = parse("data/bigtext/%d.txt" % lines)
        text = big(text, ds)
    if "t" in flags:
        text = thicken(text)
    if "f" in flags:
        text = flip(text)
    if "u" in flags:
        text = upside_down(text)
    if "r" in flags:
        text = "\n".join("".join("\x03%.2d%s" % (colors[(n+int(m/2))%k], i[2*m:2*(m+1)]) if i[2*m:2*(m+1)].strip() else i[2*m:2*(m+1)] for m in range(int((len(i)+1)/2))) for n, i in enumerate(map(ircstrip, text.split("\n"))))
    if "b" in flags:
        text = "\n".join("\x02" + x for x in text.split("\n"))
    if lines == 1:
        text = "â”‚ " + text
    return minify(text)

@Callback.threadsafe
@command("bigvars")
def bigvars(server, message):
    return "â”‚ " + (", ".join("$" + x for x in mapping))

def smallvars(server, line):
    msg = Message(line)
    text = re.sub(r"\$[a-z]+", subs, msg.text, flags=re.IGNORECASE)
    if text != msg.text and msg.text[0] not in ".!@:":
        server.message("â”‚ "+text, msg.context)

__callbacks__ = {"privmsg":[bigtext, bigvars, smallvars]}